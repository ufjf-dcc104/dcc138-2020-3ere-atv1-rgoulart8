<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC138 Exemplo01</title>
</head>
<body>
    <h1>DCC138 Exemplo01</h1>

    <canvas></canvas>

    <p>por Raquel Goulart</p>

    <script>
    let canvas = document.querySelector("canvas");
    let ctx = canvas.getContext("2d");
    canvas.width = 480;
    canvas.height = 320;
    let t0;
    let dt;
    const k = 180;

 //Transforma "personagem (p)" e "inimigo (e)" em estruturas

    let p = {
        x : 150,
        vx : 0,
        ax : 0,
        y : 100,
        vy : 0,
        ay : 0,
        cor: "blue",
        desenhar: desenhaElemento,
        mover: moverElemento,
    }

    const sprites = [];
    for (let ne = 0; ne < 20; ne++) {
        let e = {
            x :canvas.width * Math.random(),
            vx: 0,
            ax: 0,
            y :canvas.height * Math.random(),
            vy: 0,
            ay: 0,
            cor: "yellow",
            desenhar: desenhaElemento,
            mover: moverElemento,
            controlar: perseguirAlvo,
    };
     sprites.push(e);
    }

    let o = {
        x : -1000,
        vx : 0,
        ax : 0,
        y : 150,
        vy : 0,
        ay : 0,
        cor: "pink",
        desenhar: desenhaElemento,
        mover: moverElemento,
        controlar : function () {
            if (this.x> canvas.width + 60){
                this.x=-1000;
                this.ax=0;
                this.vx=200;
            }

        }
    }

    sprites.push(o);

  //Desenha a tela do programa 

    requestAnimationFrame(desenha);
    
    function desenha (t) {
        t0 = t0 ?? t;
        dt = (t -t0)/1000;

         //Desenha fundo
        ctx.fillStyle = "black";
        ctx.fillRect(0,0, canvas.width, canvas.height);

        p.mover();
        p.desenhar();

        for (let s = 0; s < sprites.length; s++) {
            
            const sprite = sprites[s];
            //Controladores 
            sprite.controlar?.(p);  
            //Atualiza dinâmica dos estado      
            sprite.mover?.();
            //Desenha elementos
            sprite.desenhar();
        }

        //Repete a função desenha
        requestAnimationFrame(desenha);
        t0=t;
    }

//Função para mover elementos

    function moverElemento(){
        this.x = this.x + this.vx*dt;
        this.vy = this.vy + this.ay*dt;
        this.y = this.y + this.vy*dt;
        this.vx = this.vx + this.ax*dt;
        }
//Função que desenha os elementos na tela 

    function desenhaElemento(){
        ctx.fillStyle = this.cor;
        ctx.fillRect(this.x, this.y, 20, 20);
        }
//Cria funções para perseguir ou evitar o alvo

    function perseguirAlvo(alvo){
        this.ay = 0.5*(alvo.y - this.y) - 0.2*this.vy;
        this.ax = 0.5*(alvo.x - this.x) - 0.2*this.vx;

    }   
    function evitarAlvo(alvo){
        this.ay = -0.5*(alvo.y - this.y) - 0.2*this.vy;
        this.ax = -0.5*(alvo.x - this.x) - 0.2*this.vx;

    }   

 //Adiciona eventos e funções para reconhecer os eventos 
    
    addEventListener ("keydown", teclaPressionada);
    addEventListener ("keyup", teclaSolta);

    function teclaPressionada (event) {

        //Adiciona controle de velocidades

        console.log(event.key);

        switch (event.key) {

            case "ArrowUp":
                p.ay = -k;
                break;
            case "ArrowDown":
                p.ay = +k;
                break;
            case "ArrowLeft":
                p.ax = -k;
                break;
            case "ArrowRight":
                p.ax = +k;
                break;
            default:
                break;
        }

    }

    function teclaSolta (event) {

//Adiciona controle de velocidades

console.log(event.key);

switch (event.key) {

    case "ArrowUp":
        p.ay = 0;
        break;
    case "ArrowDown":
        p.ay = 0;
        break;
    case "ArrowLeft":
        p.ax = 0;
        break;
    case "ArrowRight":
        p.ax = 0;
        break;
    case " ":
        if (o.x === -1000) {
        o.x = p.x;
        o.y = p.y;
        o.vx = 0;
        o.ax = 100;}

        break;
    default:
        break;
}

}
    

    </script>
    </body>
</html>